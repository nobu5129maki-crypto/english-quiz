<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ëã±ÂçòË™û„Éû„Çπ„Çø„Éº Pro (Âæ©Áøí„É¢„Éº„Éâ‰øÆÊ≠£Áâà)</title>
    <style>
        :root { --primary: #4CAF50; --bg: #eef2f3; --review: #f39c12; --listen: #9b59b6; --time: #e74c3c; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .card { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; position: relative; }
        .header-controls { display: flex; flex-direction: column; gap: 10px; margin-bottom: 1rem; }
        .top-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .mode-selector { display: flex; background: #ddd; border-radius: 12px; padding: 4px; gap: 4px; flex-grow: 1; flex-wrap: wrap; }
        .mode-option { flex: 1; min-width: 40px; padding: 8px 5px; font-size: 0.75rem; border-radius: 8px; cursor: pointer; font-weight: bold; color: #666; transition: 0.3s; text-align: center; }
        .mode-option.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .mode-option.review-mode.active { color: var(--review); }
        #time-tri-btn { font-size: 1.2rem; padding: 2px 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 8px; }
        #time-tri-btn.active { color: var(--time); background: #ffdada; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .timer-display { font-size: 1.2rem; font-weight: bold; color: var(--time); visibility: hidden; min-width: 60px; }
        .highscore-display { font-size: 0.8rem; color: #7f8c8d; margin-top: 5px; background: #f9f9f9; padding: 4px; border-radius: 8px; }
        .word-display { font-size: 2.2rem; font-weight: bold; margin-bottom: 1rem; color: #2c3e50; min-height: 3.5rem; display: flex; justify-content: center; align-items: center; }
        .options-grid { display: grid; gap: 10px; }
        .option-btn { padding: 14px; border: 2px solid #ddd; border-radius: 12px; background: white; cursor: pointer; font-size: 1rem; font-weight: bold; transition: 0.2s; }
        .option-btn:active { transform: scale(0.98); }
        .option-btn.correct { background: #d4edda !important; border-color: #28a745 !important; color: #155724 !important; }
        .option-btn.wrong { background: #f8d7da !important; border-color: #dc3545 !important; color: #721c24 !important; }
        #spell-input-area { display: none; }
        #spell-input { width: 90%; padding: 14px; font-size: 1.4rem; border: 2px solid #ddd; border-radius: 12px; text-align: center; margin-bottom: 10px; box-sizing: border-box; }
        .hint-btn { background: none; border: 1px solid #aaa; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; color: #666; margin-bottom: 10px; }
        .speaker-btn { background: #f0f0f0; border: 2px solid #ddd; border-radius: 50%; width: 55px; height: 55px; cursor: pointer; font-size: 1.6rem; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px auto; }
        .btn-main { padding: 15px 25px; cursor: pointer; background: var(--primary); color: white; border: none; border-radius: 12px; width: 100%; margin-top: 20px; font-size: 1.1rem; font-weight: bold; }
        #feedback { margin-top: 10px; font-weight: bold; min-height: 24px; font-size: 1.1rem; }
        .review-count { font-size: 0.7rem; display: block; color: #e67e22; }
    </style>
</head>
<body>

<div class="card" id="game-card">
    <div id="game-content">
        <div class="header-controls">
            <div class="top-row">
                <div class="mode-selector">
                    <div class="mode-option active" data-mode="choice" onclick="changeMode('choice')">4Êäû</div>
                    <div class="mode-option" data-mode="spell" onclick="changeMode('spell')">Êõ∏„Åè</div>
                    <div class="mode-option" data-mode="listen" onclick="changeMode('listen')">ËÅû„Åè</div>
                    <div class="mode-option review-mode" data-mode="review" onclick="changeMode('review')">Âæ©Áøí <span id="review-badge" class="review-count">(0)</span></div>
                    <div class="mode-option" id="time-tri-btn" onclick="toggleTimeTrial()">‚è±</div>
                </div>
                <div id="timer" class="timer-display">10:00</div>
            </div>
            <div class="highscore-display">ÊúÄÈ´òË®òÈå≤: <span id="high-score">0</span></div>
        </div>
        <div class="score-board" style="color:#7f8c8d; margin-bottom:5px; font-size: 0.9rem; font-weight: bold;">
            „Çπ„Ç≥„Ç¢: <span id="score" style="color:var(--primary);">0</span>
        </div>
        <div class="word-display"><span id="target-display">Loading...</span></div>
        
        <button id="speaker-icon" class="speaker-btn" onclick="retrySpeak()">üîä</button>
        
        <div class="options-grid" id="options"></div>
        
        <div id="spell-input-area">
            <input type="text" id="spell-input" placeholder="„Çπ„Éö„É´„ÇíÂÖ•Âäõ..." autocomplete="off">
            <br>
            <button class="hint-btn" onclick="showHint()">üí° „Éí„É≥„Éà</button>
            <div id="hint-text" style="font-size: 0.8rem; color: #f39c12; letter-spacing: 2px; height: 20px;"></div>
        </div>
        
        <div id="feedback"></div>
    </div>
</div>

<script>
    const masterWordList = [
        { en: "Hello", ja: "„Åì„Çì„Å´„Å°„ÅØ" }, { en: "Thank you", ja: "„ÅÇ„Çä„Åå„Å®„ÅÜ" },
        { en: "Excuse me", ja: "„Åô„Åø„Åæ„Åõ„Çì" }, { en: "I'm sorry", ja: "„Åî„ÇÅ„Çì„Å™„Åï„ÅÑ" },
        { en: "Good morning", ja: "„Åä„ÅØ„Çà„ÅÜ" }, { en: "Good night", ja: "„Åä„ÇÑ„Åô„Åø„Å™„Åï„ÅÑ" },
        { en: "Nice to meet you", ja: "„ÅØ„Åò„ÇÅ„Åæ„Åó„Å¶" }, { en: "How are you?", ja: "„ÅäÂÖÉÊ∞ó„Åß„Åô„ÅãÔºü" },
        { en: "Please", ja: "„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô" }, { en: "my", ja: "ÁßÅ„ÅÆ" },
        { en: "me", ja: "ÁßÅ„Çí" }, { en: "mine", ja: "ÁßÅ„ÅÆ„ÇÇ„ÅÆ" },
        { en: "yours", ja: "„ÅÇ„Å™„Åü„ÅÆ„ÇÇ„ÅÆ" }, { en: "his", ja: "ÂΩº„ÅÆ" },
        { en: "she", ja: "ÂΩºÂ•≥" }, { en: "her", ja: "ÂΩºÂ•≥„ÅÆ" },
        { en: "hers", ja: "ÂΩºÂ•≥„ÅÆ„ÇÇ„ÅÆ" }, { en: "it", ja: "„Åù„Çå" },
        { en: "its", ja: "„Åù„Çå„ÅÆ" }, { en: "they", ja: "ÂΩº„Çâ„ÄÅ„Åù„Çå„Çâ" },
        { en: "their", ja: "ÂΩº„Çâ„ÅÆ„ÄÅ„Åù„Çå„Çâ„ÅÆ" }, { en: "them", ja: "ÂΩº„Çâ„Çí„ÄÅ„Åù„Çå„Çâ„Çí" },
        { en: "theirs", ja: "ÂΩº„Çâ„ÅÆ„ÇÇ„ÅÆ„ÄÅ„Åù„Çå„Çâ„ÅÆ„ÇÇ„ÅÆ" }, { en: "we", ja: "ÁßÅ„Åü„Å°" },
        { en: "our", ja: "ÁßÅ„Åü„Å°„ÅÆ" }, { en: "us", ja: "ÁßÅ„Åü„Å°„Çí" },
        { en: "ours", ja: "ÁßÅ„Åü„Å°„ÅÆ„ÇÇ„ÅÆ" }, { en: "what", ja: "‰Ωï" },
        { en: "where", ja: "„Å©„Åì" }, { en: "when", ja: "„ÅÑ„Å§" },
        { en: "who", ja: "Ë™∞" }, { en: "whose", ja: "Ë™∞„ÅÆ" },
        { en: "which", ja: "„Å©„Å°„Çâ„ÅÆ" }, { en: "how", ja: "„Å©„ÅÜ„ÇÑ„Å£„Å¶" },
        { en: "sunny", ja: "Êô¥„Çå„Å¶„ÅÑ„Çã" }, { en: "cloudy", ja: "Êõá„Å£„Å¶„ÅÑ„Çã" }, 
        { en: "rainy", ja: "Èõ®„ÅåÈôç„Å£„Å¶„ÅÑ„Çã" }, { en: "snowy", ja: "Èõ™„ÅåÈôç„Å£„Å¶„ÅÑ„Çã" }, 
        { en: "friend", ja: "Âèã„Å†„Å°" }, { en: "apple", ja: "„Çä„Çì„Åî" },
        { en: "book", ja: "Êú¨" }, { en: "school", ja: "Â≠¶Ê†°" },
        { en: "student", ja: "ÁîüÂæí" }, { en: "teacher", ja: "ÂÖàÁîü" },
        { en: "dog", ja: "Áä¨" }, { en: "cat", ja: "Áå´" },
        { en: "water", ja: "Ê∞¥" }, { en: "food", ja: "È£ü„ÅπÁâ©" },
        { en: "happy", ja: "Âπ∏„Åõ„Å™" }, { en: "sad", ja: "ÊÇ≤„Åó„ÅÑ" },
        { en: "big", ja: "Â§ß„Åç„ÅÑ" }, { en: "small", ja: "Â∞è„Åï„ÅÑ" }
    ];

    let currentActiveList = [], currentIndex = 0, score = 0, isChecking = false;
    let currentMode = 'choice', isTimeTrial = false, timerInterval = null, timeLeft = 600;
    let reviewList = [];

    // localStorage„ÅÆÂÆâÂÖ®„Å™Ë™≠„ÅøËæº„Åø
    function loadReviewList() {
        try {
            const saved = localStorage.getItem('review_words');
            reviewList = saved ? JSON.parse(saved) : [];
        } catch (e) {
            reviewList = [];
        }
    }

    function saveReviewList() {
        localStorage.setItem('review_words', JSON.stringify(reviewList));
    }

    function shuffle(array) {
        let arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    function updateReviewBadge() {
        document.getElementById('review-badge').textContent = `(${reviewList.length})`;
    }

    function changeMode(mode) {
        if (mode === 'review' && reviewList.length === 0) {
            alert("Âæ©Áøí„ÅåÂøÖË¶Å„Å™ÂçòË™û„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÈñìÈÅï„Åà„Çã„Å®„Åì„Åì„Å´Ê∫ú„Åæ„Çä„Åæ„ÅôÔºÅ");
            return;
        }
        currentMode = mode;
        const opts = document.querySelectorAll('.mode-option');
        opts.forEach(opt => {
            opt.classList.toggle('active', opt.getAttribute('data-mode') === mode);
        });
        updateHighScoreDisplay();
        resetProgress();
    }

    function toggleTimeTrial() {
        isTimeTrial = !isTimeTrial;
        document.getElementById('timer').style.visibility = isTimeTrial ? 'visible' : 'hidden';
        document.getElementById('time-tri-btn').classList.toggle('active');
        if(isTimeTrial) startTimer(); else stopTimer();
        resetProgress();
    }

    function startTimer() { 
        stopTimer(); 
        timeLeft = 600; 
        updateTimerText(); 
        timerInterval = setInterval(() => { 
            timeLeft--; 
            updateTimerText(); 
            if(timeLeft <= 0) { stopTimer(); finish("„Çø„Ç§„É†„Ç¢„ÉÉ„ÉóÔºÅ"); } 
        }, 1000); 
    }
    
    function stopTimer() { clearInterval(timerInterval); }
    function updateTimerText() { 
        const m = Math.floor(timeLeft / 60); 
        const s = timeLeft % 60; 
        document.getElementById('timer').textContent = `${m}:${s.toString().padStart(2, '0')}`; 
    }
    
    function updateHighScoreDisplay() { 
        document.getElementById('high-score').textContent = localStorage.getItem(`hs_${currentMode}_${isTimeTrial}`) || 0; 
    }

    function resetProgress() {
        if (currentMode === 'review') {
            currentActiveList = shuffle(reviewList);
        } else {
            currentActiveList = shuffle(masterWordList);
        }
        currentIndex = 0; score = 0;
        document.getElementById('score').textContent = "0";
        showQuestion();
    }

    function showQuestion() {
        if (currentActiveList.length === 0) {
            finish("„É™„Çπ„Éà„ÅåÁ©∫„Åß„ÅôÔºÅ");
            return;
        }
        if (currentIndex >= currentActiveList.length) {
            if(isTimeTrial) { 
                currentActiveList = shuffle(currentMode === 'review' ? reviewList : masterWordList); 
                currentIndex = 0; 
            } else { 
                finish("ÂÖ®ÂïèÁµÇ‰∫ÜÔºÅ"); return; 
            }
        }
        
        isChecking = false;
        const q = currentActiveList[currentIndex];
        document.getElementById('feedback').textContent = "";
        document.getElementById('hint-text').textContent = "";
        
        const display = document.getElementById('target-display');
        const inputArea = document.getElementById('spell-input-area');
        const optionsArea = document.getElementById('options');
        const speaker = document.getElementById('speaker-icon');

        if (currentMode === 'spell') {
            display.textContent = q.ja; 
            speaker.style.display = 'none'; 
            inputArea.style.display = 'block'; 
            optionsArea.style.display = 'none';
            const input = document.getElementById('spell-input'); 
            input.value = ""; 
            input.disabled = false; 
            input.focus();
        } else if (currentMode === 'listen') {
            display.textContent = "???"; 
            speaker.style.display = 'flex'; 
            inputArea.style.display = 'none'; 
            optionsArea.style.display = 'grid';
            speak(q.en); setupOptions(q);
        } else {
            // 4Êäû„Åæ„Åü„ÅØÂæ©Áøí„É¢„Éº„ÉâÔºà4ÊäûÂΩ¢ÂºèÔºâ
            display.textContent = q.en; 
            speaker.style.display = 'flex'; 
            inputArea.style.display = 'none'; 
            optionsArea.style.display = 'grid';
            speak(q.en); setupOptions(q);
        }
    }

    function setupOptions(q) {
        const others = masterWordList.filter(w => w.ja !== q.ja);
        const opts = shuffle([q.ja, ...shuffle(others).slice(0, 3).map(w => w.ja)]);
        const container = document.getElementById('options');
        container.innerHTML = '';
        opts.forEach(o => {
            const btn = document.createElement('button');
            btn.className = 'option-btn'; btn.textContent = o;
            btn.onclick = () => check(o === q.ja, btn);
            container.appendChild(btn);
        });
    }

    function check(isCorrect, targetElement = null) {
        if(isChecking) return;
        isChecking = true;
        const q = currentActiveList[currentIndex];
        
        if (currentMode === 'listen') document.getElementById('target-display').textContent = q.en;

        const feedback = document.getElementById('feedback');
        if(isCorrect) {
            if(targetElement) targetElement.classList.add('correct');
            score++; 
            document.getElementById('score').textContent = score;
            feedback.innerHTML = `<span style="color:var(--primary)">‚ú®Ê≠£Ëß£: ${q.en}</span>`;
            
            if (currentMode === 'review') {
                reviewList = reviewList.filter(item => item.en !== q.en);
                saveReviewList();
                updateReviewBadge();
            }
        } else {
            if(targetElement) targetElement.classList.add('wrong');
            feedback.innerHTML = `<span style="color:var(--time)">‚ùå‰∏çÊ≠£Ëß£: ${q.en}</span>`;
            
            if (!reviewList.some(item => item.en === q.en)) {
                reviewList.push(q);
                saveReviewList();
                updateReviewBadge();
            }
        }
        
        speak(q.en);
        setTimeout(() => { currentIndex++; showQuestion(); }, isCorrect ? 1000 : 2500);
    }

    function showHint() {
        const q = currentActiveList[currentIndex];
        if(!q) return;
        const hint = q.en[0] + "_".repeat(q.en.length - 2) + q.en.slice(-1);
        document.getElementById('hint-text').textContent = hint;
    }

    function speak(text) {
        if (!('speechSynthesis' in window)) return;
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        u.rate = 0.9; 
        speechSynthesis.speak(u);
    }

    function retrySpeak() { if (currentActiveList[currentIndex]) speak(currentActiveList[currentIndex].en); }

    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
    document.getElementById('spell-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const val = document.getElementById('spell-input').value.trim().toLowerCase();
            check(val === currentActiveList[currentIndex].en.toLowerCase());
        }
    });

    function finish(msg) {
        stopTimer();
        const key = `hs_${currentMode}_${isTimeTrial}`;
        const oldHS = parseInt(localStorage.getItem(key) || 0);
        if(score > oldHS) localStorage.setItem(key, score);
        
        document.getElementById('game-card').innerHTML = `
            <h2>${msg}</h2>
            <p style="font-size:1.8rem; color:var(--primary); font-weight:bold;">„Çπ„Ç≥„Ç¢: ${score}</p>
            <p>ÊúÄÈ´òË®òÈå≤: ${Math.max(score, oldHS)}</p>
            <p style="color:#e67e22;">Âæ©Áøí„ÅåÂøÖË¶Å„Å™ÂçòË™û: ${reviewList.length} ‰ª∂</p>
            <button onclick="location.reload()" class="btn-main">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶</button>
        `;
    }

    // ÂàùÊúüËµ∑ÂãïÂá¶ÁêÜ
    window.onload = () => {
        loadReviewList();
        updateReviewBadge();
        updateHighScoreDisplay();
        resetProgress();
    };

</script>
</body>
</html>