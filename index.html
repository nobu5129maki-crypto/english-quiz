<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±å˜èªãƒã‚¹ã‚¿ãƒ¼ Pro (ãƒªã‚¹ãƒ‹ãƒ³ã‚°å¯¾å¿œ)</title>
    <style>
        :root { --primary: #4CAF50; --bg: #eef2f3; --review: #f39c12; --listen: #9b59b6; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #effect-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .card { background: white; padding: 2.5rem; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; position: relative; z-index: 20; }
        
        .header-controls { display: flex; flex-direction: column; gap: 10px; margin-bottom: 1.5rem; }
        .top-row { display: flex; justify-content: space-between; align-items: center; }
        
        /* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’3æ®µéšã«å¯¾å¿œ */
        .mode-selector { display: flex; background: #ddd; border-radius: 10px; padding: 3px; gap: 2px; }
        .mode-option { flex: 1; padding: 5px 10px; font-size: 0.75rem; border-radius: 8px; cursor: pointer; font-weight: bold; color: #666; transition: 0.3s; }
        .mode-option.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .mode-option.active.listen-mode { color: var(--listen); }

        .review-trigger { background: var(--review); color: white; border: none; border-radius: 12px; padding: 5px 12px; font-size: 0.8rem; cursor: pointer; display: none; font-weight: bold; }
        
        .word-display { font-size: 2.5rem; font-weight: bold; margin-bottom: 1.5rem; color: #2c3e50; min-height: 3.5rem; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .options-grid { display: grid; gap: 10px; }
        .option-btn { padding: 15px; border: 2px solid #ddd; border-radius: 12px; background: white; cursor: pointer; font-size: 1.1rem; }
        .option-btn.correct { background: #d4edda; border-color: #28a745; }
        .option-btn.wrong { background: #f8d7da; border-color: #dc3545; }

        #spell-input-area { display: none; }
        #spell-input { width: 85%; padding: 12px; font-size: 1.2rem; border: 2px solid #ddd; border-radius: 10px; text-align: center; }
        
        .speaker-btn { background: #eee; border: none; border-radius: 50%; width: 60px; height: 60px; cursor: pointer; font-size: 1.8rem; transition: transform 0.1s; }
        .speaker-btn:active { transform: scale(0.9); }
        .btn-main { padding: 12px 25px; cursor: pointer; background: var(--primary); color: white; border: none; border-radius: 8px; width: 100%; margin-top: 10px; }
        #feedback { margin-top: 20px; font-weight: bold; min-height: 30px; }
    </style>
</head>
<body>

<canvas id="effect-canvas"></canvas>

<div class="card" id="game-card">
    <div class="header-controls">
        <div class="top-row">
            <div class="mode-selector" id="mode-selector">
                <div class="mode-option active" onclick="changeMode('choice')">4æŠ</div>
                <div class="mode-option" onclick="changeMode('spell')">æ›¸ã</div>
                <div class="mode-option" onclick="changeMode('listen')">èã</div>
            </div>
            <button id="review-btn" class="review-trigger" onclick="startReviewMode()">âš¡ å¾©ç¿’ (<span id="wrong-count">0</span>)</button>
        </div>
    </div>

    <div class="score-board" style="color:#7f8c8d; margin-bottom:10px; font-size: 0.9rem;">
        <span id="list-label" style="font-weight:bold;">å•é¡Œ</span>: <span id="current">1</span>/<span id="total">0</span> | ã‚¹ã‚³ã‚¢: <span id="score">0</span>
    </div>

    <div class="word-display">
        <span id="target-display">---</span>
        <button id="speaker-icon" class="speaker-btn" onclick="retrySpeak()">ğŸ”Š</button>
    </div>

    <div class="options-grid" id="options"></div>

    <div id="spell-input-area">
        <input type="text" id="spell-input" placeholder="ã“ã“ã«å…¥åŠ›..." autocomplete="off">
        <br><br>
        <button class="hint-btn" onclick="showHint()" style="background:none; border:1px solid #aaa; padding:5px 10px; border-radius:10px; cursor:pointer;">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</button>
        <div id="hint-display" style="margin-top:10px; letter-spacing: 2px;"></div>
    </div>

    <div id="feedback"></div>
</div>

<script>
    const masterWordList = [
                { en: "Hello", ja: "ã“ã‚“ã«ã¡ã¯" },
        { en: "Thank you", ja: "ã‚ã‚ŠãŒã¨ã†" },
        { en: "Excuse me", ja: "ã™ã¿ã¾ã›ã‚“" },
        { en: "I'm sorry", ja: "ã”ã‚ã‚“ãªã•ã„" },
        { en: "Good morning", ja: "ãŠã¯ã‚ˆã†" },
        { en: "Good night", ja: "ãŠã‚„ã™ã¿ãªã•ã„" },
        { en: "Nice to meet you", ja: "ã¯ã˜ã‚ã¾ã—ã¦" },
        { en: "How are you?", ja: "ãŠå…ƒæ°—ã§ã™ã‹ï¼Ÿ" },
        { en: "Please", ja: "ãŠé¡˜ã„ã—ã¾ã™" },
        { en: "my", ja: "ç§ã®" },
        { en: "me", ja: "ç§ã‚’" },
        { en: "mine", ja: "ç§ã®ã‚‚ã®" },
        { en: "yours", ja: "ã‚ãªãŸã®ã‚‚ã®" },
        { en: "his", ja: "å½¼ã®" },
        { en: "she", ja: "å½¼å¥³" },
        { en: "her", ja: "	å½¼å¥³ã®" },
        { en: "hers", ja: "å½¼å¥³ã®ã‚‚ã®" },
        { en: "it", ja: "ãã‚Œ" },
        { en: "its", ja: "ãã‚Œã®" },
        { en: "they", ja: "å½¼ã‚‰ã€ãã‚Œã‚‰" },
        { en: "their", ja: "å½¼ã‚‰ã®ã€ãã‚Œã‚‰ã®" },
        { en: "them", ja: "å½¼ã‚‰ã‚’ã€ãã‚Œã‚‰ã‚’" },
        { en: "theirs", ja: "å½¼ã‚‰ã®ã‚‚ã®ã€ãã‚Œã‚‰ã®ã‚‚ã®" },
        { en: "we", ja: "ç§ãŸã¡" },
        { en: "our", ja: "	ç§ãŸã¡ã®" },
        { en: "us", ja: "ç§ãŸã¡ã‚’" },
        { en: "ours", ja: "ç§ãŸã¡ã®ã‚‚ã®" },
        { en: "what", ja: "ä½•" },
        { en: "what color", ja: "ä½•è‰²" },
        { en: "what sports", ja: "ä½•ã®ã‚¹ãƒãƒ¼ãƒ„" },
        { en: "wahat subject", ja: "ä½•ã®ç§‘ç›®" },
         { en: "what day is it today ?", ja: "ä»Šæ—¥ã¯ä½•æ›œæ—¥ï¼Ÿ" },
          { en: "what's your favorite ~ ? ", ja: "ã‚ãªãŸã®å¥½ããªï½ã¯ãªã‚“ã§ã™ã‹ï¼Ÿ" },
           { en: "where", ja: "ã©ã“" },
            { en: "when", ja: "ã„ã¤" },
             { en: "who", ja: "èª°" },
      { en: "whose", ja: "èª°ã®" },
       { en: "which", ja: "ã©ã¡ã‚‰ã®" },
        { en: "how", ja: "ã©ã†ã‚„ã£ã¦" },
         { en: "How do you get to ~ ?", ja: "ã©ã†ã‚„ã£ã¦ï½ã¸è¡Œãã¾ã™ã‹ï¼Ÿ" },
          { en: "How are you?", ja: "å…ƒæ°—ã§ã™ã‹ï¼Ÿ" },
           { en: "How old", ja: "ä½•æ­³" },
            { en: "How much", ja: "ã„ãã‚‰" },
              { en: "How many ?", ja: "ã„ãã¤" },  
       { en: "How about ~ ?", ja: "ï½ã¯ã©ã†ã§ã™ã‹ï¼Ÿ" },  
         { en: "how tall", ja: "ã©ã®ãã‚‰ã„ã®é«˜ã•" },  
           { en: "how long", ja: "ã©ã®ãã‚‰ã„ã®é•·ã•" },  
             { en: "one o'clock", ja: "1æ™‚" },  
               { en: "two o'clock", ja: "2æ™‚" },  
                 { en: "three o'clock", ja: "3æ™‚" },                   
       { en: "four o'clock", ja: "4æ™‚" },  
         { en: "five o'clock", ja: "5æ™‚" },  
           { en: "six o'clock", ja: "6æ™‚" },  
             { en: "seven o'clock", ja: "7æ™‚" },
               { en: "eight o'clock", ja: "8æ™‚" },
        { en: "nine o'clock", ja: "9æ™‚" },
          { en: "ten o'clock", ja: "10æ™‚" },
            { en: "eleven o'clock", ja: "11æ™‚" },
              { en: "twelve o'clock", ja: "12æ™‚" },
                { en: "minute", ja: "åˆ†" },
       { en: "hour", ja: "æ™‚é–“" },
         { en: "day", ja: "æ—¥" },
           { en: "week", ja: "é€±" },
             { en: "month", ja: "æœˆ" },
               { en: "year", ja: "å¹´" },
                 { en: "today", ja: "ä»Šæ—¥" },
       { en: "weekend", ja: "é€±æœ«" },
         { en: "morning", ja: "æœ/åˆå‰ä¸­" },
           { en: "afternoon", ja: "åˆå¾Œ" },
             { en: "evening", ja: "æ™©" },
               { en: "night", ja: "å¤œ" },
       { en: "midnight", ja: "æ·±å¤œ" },
         { en: "birthday", ja: "èª•ç”Ÿæ—¥" },
           { en: "Monday", ja: "æœˆæ›œæ—¥" },
             { en: "Tuesday", ja: "ç«æ›œæ—¥" },
               { en: "Wednesday", ja: "æ°´æ›œæ—¥" },
       { en: "Thursday", ja: "æœ¨æ›œæ—¥" },
         { en: "Friday", ja: "é‡‘æ›œæ—¥" },
           { en: "Saturday", ja: "åœŸæ›œæ—¥" },
             { en: "Sunday", ja: "æ—¥æ›œæ—¥" },
               { en: "January", ja: "1æœˆ" },
                 { en: "February", ja: "2æœˆ" },
       { en: "March", ja: "3æœˆ" },
         { en: "April", ja: "4æœˆ" },
           { en: "May", ja: "5æœˆ" },
             { en: "June", ja: "6æœˆ" },
               { en: "July", ja: "7æœˆ" },
                 { en: "August", ja: "8æœˆ" },
        { en: "September", ja: "9æœˆ" },
          { en: "October", ja: "10æœˆ" },
            { en: "November", ja: "11æœˆ" },
              { en: "December", ja: "12æœˆ" },
     { en: "spring", ja: "æ˜¥" },   
     { en: "summer", ja: "å¤" },   
     { en: "automn", ja: "ç§‹" },   
     { en: "fall", ja: "ç§‹" },   
     { en: "winter", ja: "å†¬" },   
     { en: "Japan", ja: "æ—¥æœ¬" },   
     { en: "America", ja: "ã‚¢ãƒ¡ãƒªã‚«" },   
     { en: "Canada", ja: "ã‚«ãƒŠãƒ€" },   
     { en: "Australia", ja: "ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢" },   
     { en: "Spain", ja: "ã‚¹ãƒšã‚¤ãƒ³" },   
     { en: "China", ja: "ä¸­å›½" },   
     { en: "France", ja: "ãƒ•ãƒ©ãƒ³ã‚¹" },   
     { en: "Germany", ja: "ãƒ‰ã‚¤ãƒ„" },   
     { en: "Brazil", ja: "ãƒ–ãƒ©ã‚¸ãƒ«" },   
     { en: "country", ja: "å›½" },   
     { en: "Africa", ja: "ã‚¢ãƒ•ãƒªã‚«" },   
     { en: "Asia", ja: "ã‚¢ã‚¸ã‚¢" },   
     { en: "Europe", ja: "ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘" },   
     { en: "place", ja: "å ´æ‰€" },   
     { en: "station", ja: "é§…" },   
     { en: "airport", ja: "ç©ºæ¸¯" },   
     { en: "park", ja: "å…¬åœ’" },   
     { en: "cityhall", ja: "å¸‚å½¹æ‰€" },   
     { en: "hospital", ja: "ç—…é™¢" },   
     { en: "post office", ja: "éƒµä¾¿å±€" },   
     { en: "store", ja: "åº—" },   
     { en: "supermarket", ja: "ã‚¹ãƒ¼ãƒ‘ãƒ¼" },   
     { en: "mountain", ja: "å±±" },   
     { en: "sea", ja: "æµ·" },   
     { en: "restaurant", ja: "ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³" },   
     { en: "home", ja: "å®¶/æ•…éƒ·" },   
     { en: "house", ja: "ä¸€è»’å®¶" },   
     { en: "room", ja: "éƒ¨å±‹" },   
     { en: "bedroom", ja: "å¯å®¤" },   
     { en: "kitchen", ja: "å°æ‰€" },   
     { en: "bathroom", ja: "ï¼ˆãƒˆã‚¤ãƒ¬ã¤ãã®ï¼‰ãŠé¢¨å‘‚" },   
     { en: "classroom", ja: "æ•™å®¤" },   
     { en: "gym", ja: "ä½“è‚²é¤¨" },   
     { en: "sunny", ja: "æ™´ã‚Œã¦ã„ã‚‹" }, 
     { en: "cloudy", ja: "æ›‡ã£ã¦ã„ã‚‹" }, 
     { en: "rainy", ja: "é›¨ãŒé™ã£ã¦ã„ã‚‹" }, 
     { en: "snowy", ja: "é›ªãŒé™ã£ã¦ã„ã‚‹" }, 
     { en: "foggy", ja: "éœ§ãŒã‹ã£ã¦ã„ã‚‹" }, 
     { en: "windy", ja: "é¢¨ãŒå¼·ã„" }, 
     { en: "sunshine", ja: "æ™´å¤©" }, 
     { en: "cloud", ja: "é›²" }, 
     { en: "rain", ja: "é›¨/é›¨ãŒé™ã‚‹" }, 
     { en: "shower", ja: "é›¨/ã«ã‚ã‹é›¨" }, 
     { en: "snow", ja: "é›ª/é›ªãŒé™ã‚‹" }, 
     { en: "fog", ja: "éœ§" }, 
     { en: "clearup", ja: "æ™´ã‚Œã‚‹" }, 
     { en: "boy", ja: "ç”·ã®å­" }, 
     { en: "children", ja: "å­ã©ã‚‚ãŸã¡" }, 
     { en: "dancer", ja: "ãŠã©ã‚‹äºº" }, 
      { en: "driver", ja: "é‹è»¢æ‰‹" }, 
     { en: "doctor", ja: "åŒ»è€…/åšå£«" }, 
     { en: "friend", ja: "å‹ã ã¡" }, 
     { en: "girl", ja: "å¥³ã®å­" }, 
     { en: "job", ja: "ä»•äº‹" }, 
     { en: "man", ja: "ç”·æ€§" }, 
     { en: "officer", ja: "è­¦å®˜/å½¹äºº" }, 
     { en: "parent", ja: "è¦ª" }, 
     { en: "brother", ja: "å…„å¼Ÿ" }, 
     { en: "sister", ja: "å§‰å¦¹" }, 
     { en: "grandfather", ja: "ãŠã˜ã„ã•ã‚“" }, 
     { en: "grandmother", ja: "	ãŠã°ã‚ã•ã‚“" }, 
     { en: "cousin", ja: "ã„ã¨ã“" }, 
     { en: "person", ja: "äºº" },
      { en: "people", ja: "äººã€…" }, 
     { en: "woman", ja: "å¥³æ€§" }, 
     { en: "worker", ja: "åƒãäºº" }, 
     { en: "basketball", ja: "ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«" }, 
     { en: "badminton", ja: "ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³" }, 
     { en: "tabletennis", ja: "å“çƒ" }, 
     { en: "swimming", ja: "æ°´æ³³" }, 
     { en: "marathon", ja: "ãƒãƒ©ã‚½ãƒ³" }, 
     { en: "dinner", ja: "å¤•é£Ÿ" }, 
     { en: "month", ja: "æœˆ" }, 
     { en: "color", ja: "è‰²" }, 
     { en: "family", ja: "å®¶æ—" }, 
     { en: "flower", ja: "èŠ±" }, 
     { en: "fruit", ja: "æœç‰©" },  
     { en: "drink", ja: "é£²ã¿ç‰©" },  
        { en: "name", ja: "åå‰" },  
        { en: "dictionary", ja: "è¾æ›¸" },  
        { en: "passport", ja: "ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ" },  
            { en: "homework", ja: "å®¿é¡Œ" },  
            { en: "food", ja: "é£Ÿã¹ç‰©" },  
    { en: "animal", ja: "å‹•ç‰©" },
    { en: "box", ja: "ç®±" },   
    { en: "watch", ja: "è…•æ™‚è¨ˆ" },
    { en: "blackboard", ja: "é»’æ¿" },
    { en: "tea", ja: "ãŠèŒ¶" },
    { en: "calendar", ja: "ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼" },
    { en: "shoes", ja: "é´" },
    { en: "umbrella", ja: "ã‹ã•" },
     { en: "newspaper", ja: "æ–°è" },
    { en: "window", ja: "çª“" },
    { en: "hair", ja: "é«ª" },
    { en: "diary", ja: "æ—¥è¨˜" },
     { en: "letter", ja: "æ‰‹ç´™" },
    { en: "wall", ja: "å£" },
    { en: "bird", ja: "é³¥" },
    { en: "doll", ja: "äººå½¢" },
     { en: "grape", ja: "ã¶ã©ã†" },
    { en: "camera", ja: "ã‚«ãƒ¡ãƒ©" },
    { en: "mouth", ja: "å£" },
    { en: "coin", ja: "ç¡¬è²¨" },
     { en: "song", ja: "æ›²" },
    { en: "music", ja: "éŸ³æ¥½" },
    { en: "garden", ja: "åº­" },
    { en: "idea", ja: "è€ƒãˆ/æ„è¦‹" },
     { en: "art", ja: "èŠ¸è¡“" },
    { en: "number", ja: "æ•°/ç•ªå·" },
    { en: "history", ja: "æ­´å²" },
    { en: "story", ja: "ç‰©èª/è©±" },
     { en: "subject", ja: "	ç§‘ç›®" },
    { en: "plane", ja: "é£›è¡Œæ©Ÿ" },
    { en: "bread", ja: "ãƒ‘ãƒ³" },
    { en: "dish", ja: "çš¿" },
     { en: "tree", ja: "æœ¨" },
    { en: "fish", ja: "é­š" },
    { en: "like", ja: "ï½ãŒå¥½ã" },
    { en: "have", ja: "ï½ã‚’æŒã£ã¦ã„ã‚‹" },
     { en: "play", ja: "ï¼ˆæ¥½å™¨ã‚’ï¼‰æ¼”å¥ã™ã‚‹ï¼ˆã‚²ãƒ¼ãƒ ã‚’ï¼‰ãƒ—ãƒ¬ã‚¤ã™ã‚‹" },
    { en: "watch", ja: "ï¼ˆãƒ†ãƒ¬ãƒ“ãªã©ï¼‰è¦‹ã‚‹" },
    { en: "want", ja: "ï½ãŒæ¬²ã—ã„" },
    { en: "eat", ja: "ï½ã‚’é£Ÿã¹ã‚‹" },
     { en: "read", ja: "ï½ã‚’èª­ã‚€" },
    { en: "see", ja: "ï½ã‚’è¦‹ã‚‹" },
    { en: "make", ja: "ï½ã‚’ã¤ãã‚‹" },
    { en: "come", ja: "æ¥ã‚‹" },
     { en: "study", ja: "å‹‰å¼·ã™ã‚‹" },
    { en: "get", ja: "ï½ã‚’æŒã¤/æ‰‹ã«å…¥ã‚Œã‚‹" },
    { en: "take", ja: "ï½ã‚’ã¨ã‚‹" },
    { en: "write", ja: "ï½ã‚’æ›¸ã" },
     { en: "work", ja: "åƒã" },
    { en: "use", ja: "ï½ã‚’ä½¿ã†" },
    { en: "drink", ja: "ï½ã‚’é£²ã‚€" },
    { en: "wash", ja: "ï½ã‚’æ´—ã†" },
     { en: "cook", ja: "ï½ã‚’æ–™ç†ã™ã‚‹" },
    { en: "speak	", ja: "ï½ã‚’è©±ã™" },
    { en: "run", ja: "èµ°ã‚‹" },
    { en: "sleep", ja: "å¯ã‚‹" },
     { en: "buy", ja: "ï½ã‚’è²·ã†" },
    { en: "open", ja: "ï½ã‚’é–‹ã‘ã‚‹ãƒ»é–‹ã" },
    { en: "swim", ja: "æ³³ã" },
     { en: "listen", ja: "è´ã" },
    { en: "look", ja: "è¦‹ã‚‹" },
    { en: "sing", ja: "æ­Œã†" },
     { en: "know", ja: "ï½ã‚’çŸ¥ã‚‹" },
    { en: "sit", ja: "åº§ã‚‹" },
    { en: "clean", ja: "ï½ã‚’æƒé™¤ã™ã‚‹" },
     { en: "help", ja: "åŠ©ã‘ã‚‹" },
    { en: "meet", ja: "ï½ã«ä¼šã†" },
    { en: "walk", ja: "æ­©ã" },
     { en: "ski", ja: "ã‚¹ã‚­ãƒ¼ã‚’ã™ã‚‹" },
    { en: "start", ja: "å§‹ã‚ã‚‹" },
    { en: "talk", ja: "è©±ã™" },
     { en: "teach", ja: "æ•™ãˆã‚‹" },
    { en: "think", ja: "è€ƒãˆã‚‹" },
    { en: "need", ja: "ï½ãŒæ¬²ã—ã„" },
     { en: "close", ja: "ï½ã‚’é–‰ã‚ã‚‹" },
    { en: "give", ja: "ï½ã‚’ã‚ã’ã‚‹ãƒ»ä¸ãˆã‚‹" },
    { en: "stop", ja: "æ­¢ã¾ã‚‹" },
     { en: "dance", ja: "ãƒ€ãƒ³ã‚¹ã™ã‚‹" },
    { en: "love", ja: "æ„›ã™ã‚‹" },
    { en: "live", ja: "ç”Ÿãã‚‹/ä½ã‚€" },
     { en: "stand", ja: "ç«‹ã¤" },
    { en: "wait", ja: "å¾…ã¤" },
    { en: "put", ja: "ï½ã‚’ç½®ã" },
     { en: "brush", ja: "ãƒ–ãƒ©ã‚·ã‚’ã‹ã‘ã‚‹" },
    { en: "ride", ja: "ä¹—ã‚‹" },
    { en: "camp", ja: "ã‚­ãƒ£ãƒ³ãƒ—ã‚’ã™ã‚‹" },
     { en: "learn", ja: "ï½ã‚’ç¿’ã†/å­¦ã¶" },
    { en: "smile	", ja: "ç¬‘ã†" },
    { en: "begin", ja: "å§‹ã‚ã‚‹" },
     { en: "enjoy", ja: "ï½ã‚’æ¥½ã—ã‚€" },
    { en: "practice", ja: "ç·´ç¿’ã™ã‚‹" },
    { en: "drive", ja: "ï½ã‚’é‹è»¢ã™ã‚‹" },
     { en: "ask", ja: "ãŠé¡˜ã„ã™ã‚‹" },
    { en: "tell", ja: "ï½ã‚’è¨€ã†" },
    { en: "fly", ja: "é£›ã¶" },
     { en: "jump", ja: "ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹" },
    { en: "stay", ja: "ã¨ã©ã¾ã‚‹" },
    { en: "move", ja: "å‹•ã" },
     { en: "turn", ja: "å›ã‚‹" },
    { en: "visit", ja: "ï½ã‚’è¨ªã­ã‚‹" },
    { en: "try", ja: "ï½ã‚’ã‚„ã£ã¦ã¿ã‚‹" },
    ];

    let currentActiveList = [];
    let wrongList = [];
    let currentIndex = 0, score = 0, isAnswered = false, nativeVoice = null;
    let currentMode = 'choice'; // 'choice', 'spell', 'listen'

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function changeMode(mode) {
        currentMode = mode;
        const options = document.querySelectorAll('.mode-option');
        options.forEach(opt => opt.classList.remove('active'));
        const idx = mode === 'choice' ? 0 : mode === 'spell' ? 1 : 2;
        options[idx].classList.add('active');
        resetProgress();
    }

    function saveGame() {
        const data = { currentIndex, score, currentMode, wrongList, currentActiveList, isReviewMode: (document.getElementById('list-label').textContent === "å¾©ç¿’") };
        localStorage.setItem('english_quiz_save_v4', JSON.stringify(data));
        updateReviewButton();
    }

    function loadGame() {
        const saved = localStorage.getItem('english_quiz_save_v4');
        if (saved) {
            const data = JSON.parse(saved);
            currentIndex = data.currentIndex;
            score = data.score;
            currentMode = data.currentMode || 'choice';
            wrongList = data.wrongList || [];
            currentActiveList = data.currentActiveList || [];
            document.getElementById('score').textContent = score;
            changeMode(currentMode); // UIåæ˜ 
            if (data.isReviewMode) document.getElementById('list-label').textContent = "å¾©ç¿’";
        } else {
            currentActiveList = shuffle([...masterWordList]);
        }
        updateReviewButton();
    }

    function updateReviewButton() {
        const btn = document.getElementById('review-btn');
        const count = document.getElementById('wrong-count');
        btn.style.display = (wrongList.length > 0 && document.getElementById('list-label').textContent !== "å¾©ç¿’") ? "block" : "none";
        count.textContent = wrongList.length;
    }

    function resetProgress() {
        currentActiveList = shuffle([...masterWordList]);
        wrongList = []; currentIndex = 0; score = 0;
        document.getElementById('score').textContent = "0";
        document.getElementById('list-label').textContent = "å•é¡Œ";
        saveGame(); showQuestion();
    }

    function startReviewMode() {
        if (wrongList.length === 0) return;
        currentActiveList = shuffle([...wrongList]);
        wrongList = []; currentIndex = 0; score = 0;
        document.getElementById('score').textContent = "0";
        document.getElementById('list-label').textContent = "å¾©ç¿’";
        saveGame(); showQuestion();
    }

    function loadVoices() { nativeVoice = speechSynthesis.getVoices().find(v => v.lang.includes('en-US') && (v.name.includes('Google') || v.name.includes('Premium'))); }
    speechSynthesis.onvoiceschanged = loadVoices;
    function speak(text) {
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        if(nativeVoice) u.voice = nativeVoice;
        u.lang = 'en-US'; u.rate = 0.8;
        speechSynthesis.speak(u);
    }

    function showQuestion() {
        if (currentIndex >= currentActiveList.length) { finish(); return; }
        isAnswered = false;
        const q = currentActiveList[currentIndex];
        document.getElementById('current').textContent = currentIndex + 1;
        document.getElementById('total').textContent = currentActiveList.length;
        document.getElementById('feedback').textContent = "";
        document.getElementById('hint-display').textContent = "";
        
        const display = document.getElementById('target-display');
        const inputArea = document.getElementById('spell-input-area');
        const optionsArea = document.getElementById('options');
        const speaker = document.getElementById('speaker-icon');

        if (currentMode === 'spell') {
            display.textContent = q.ja;
            display.style.fontSize = "2rem";
            speaker.style.display = 'none';
            inputArea.style.display = 'block';
            optionsArea.style.display = 'none';
            document.getElementById('spell-input').value = "";
            document.getElementById('spell-input').disabled = false;
            document.getElementById('spell-input').focus();
        } else if (currentMode === 'listen') {
            display.textContent = "???"; // æ–‡å­—ã¯è¦‹ã›ãªã„
            display.style.fontSize = "3rem";
            speaker.style.display = 'inline-block';
            inputArea.style.display = 'none';
            optionsArea.style.display = 'grid';
            setTimeout(() => speak(q.en), 300); // ç”»é¢åˆ‡ã‚Šæ›¿ã‚ã‚Šå¾Œã«å†ç”Ÿ
            setupOptions(q);
        } else {
            display.textContent = q.en;
            display.style.fontSize = "2.5rem";
            speaker.style.display = 'inline-block';
            inputArea.style.display = 'none';
            optionsArea.style.display = 'grid';
            speak(q.en);
            setupOptions(q);
        }
        saveGame();
    }

    function setupOptions(q) {
        const opts = shuffle([q.ja, ...masterWordList.filter(w=>w.ja!==q.ja).map(w=>w.ja).slice(0,3)]);
        const container = document.getElementById('options');
        container.innerHTML = '';
        opts.forEach(o => {
            const btn = document.createElement('button');
            btn.className = 'option-btn'; btn.textContent = o;
            btn.onclick = () => check(o === q.ja, btn);
            container.appendChild(btn);
        });
    }

    function check(isCorrect, targetElement = null) {
        if(isAnswered) return;
        isAnswered = true;
        const q = currentActiveList[currentIndex];
        const feedback = document.getElementById('feedback');
        document.getElementById('spell-input').disabled = true;

        let delay = 1500;
        if(isCorrect) {
            if(targetElement) targetElement.classList.add('correct');
            feedback.innerHTML = `<span style="color:#28a745">æ­£è§£ï¼ âœ¨</span>`;
            score++; document.getElementById('score').textContent = score;
            speak(q.en);
        } else {
            if(targetElement) targetElement.classList.add('wrong');
            feedback.innerHTML = `<span style="color:#dc3545">æ­£è§£: <strong>${q.en} (${q.ja})</strong></span>`;
            speak(q.en);
            delay = 4000;
            if (!wrongList.some(w => w.en === q.en)) wrongList.push(q);
        }
        setTimeout(() => { currentIndex++; showQuestion(); }, delay);
    }

    function showHint() {
        const q = currentActiveList[currentIndex];
        document.getElementById('hint-display').textContent = q.en[0] + " _ ".repeat(q.en.length-2) + q.en.slice(-1);
    }

    document.getElementById('spell-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') check(e.target.value.trim().toLowerCase() === currentActiveList[currentIndex].en.toLowerCase());
    });

    function retrySpeak() { speak(currentActiveList[currentIndex].en); }

    function finish() {
        localStorage.removeItem('english_quiz_save_v4');
        let html = `<h2>å®Œäº†ï¼</h2><p style="font-size:1.5rem">ã‚¹ã‚³ã‚¢: ${score}/${currentActiveList.length}</p>`;
        if (wrongList.length > 0) html += `<button onclick="startReviewMode()" class="btn-main" style="background:var(--review)">é–“é•ãˆãŸå•é¡Œã‚’å¾©ç¿’</button>`;
        html += `<button onclick="location.reload()" class="btn-main">æœ€åˆã‹ã‚‰</button>`;
        document.getElementById('game-card').innerHTML = html;
    }

    // Canvas ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆç°¡æ˜“ç‰ˆï¼‰
    const canvas = document.getElementById('effect-canvas');
    const ctx = canvas.getContext('2d');
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    loadGame();
    showQuestion();
</script>
</body>
</html>