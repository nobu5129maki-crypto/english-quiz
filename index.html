<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-512.png">
    <title>è‹±å˜èªãƒã‚¹ã‚¿ãƒ¼ Pro (å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰æ­è¼‰ç‰ˆ)</title>
    <style>
        :root { --primary: #4CAF50; --bg: #eef2f3; --review: #f39c12; --listen: #9b59b6; --time: #e74c3c; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .card { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; position: relative; z-index: 20; }
        .header-controls { display: flex; flex-direction: column; gap: 10px; margin-bottom: 1rem; }
        .top-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .mode-selector { display: flex; background: #ddd; border-radius: 12px; padding: 4px; gap: 4px; flex-grow: 1; flex-wrap: wrap; }
        .mode-option { flex: 1; min-width: 40px; padding: 8px 5px; font-size: 0.75rem; border-radius: 8px; cursor: pointer; font-weight: bold; color: #666; transition: 0.3s; text-align: center; }
        .mode-option.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .mode-option.review-mode.active { color: var(--review); }
        #time-tri-btn { font-size: 1.2rem; padding: 2px 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 8px; }
        #time-tri-btn.active { color: var(--time); background: #ffdada; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .timer-display { font-size: 1.2rem; font-weight: bold; color: var(--time); visibility: hidden; min-width: 60px; }
        .highscore-display { font-size: 0.8rem; color: #7f8c8d; margin-top: 5px; background: #f9f9f9; padding: 4px; border-radius: 8px; }
        .word-display { font-size: 2.2rem; font-weight: bold; margin-bottom: 1rem; color: #2c3e50; min-height: 3.5rem; display: flex; justify-content: center; align-items: center; }
        .options-grid { display: grid; gap: 10px; }
        .option-btn { padding: 14px; border: 2px solid #ddd; border-radius: 12px; background: white; cursor: pointer; font-size: 1rem; font-weight: bold; }
        .option-btn.correct { background: #d4edda; border-color: #28a745; color: #155724; }
        .option-btn.wrong { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        #spell-input-area { display: none; }
        #spell-input { width: 85%; padding: 14px; font-size: 1.4rem; border: 2px solid #ddd; border-radius: 12px; text-align: center; margin-bottom: 10px; }
        .hint-btn { background: none; border: 1px solid #aaa; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; color: #666; margin-bottom: 10px; }
        .speaker-btn { background: #f0f0f0; border: 2px solid #ddd; border-radius: 50%; width: 55px; height: 55px; cursor: pointer; font-size: 1.6rem; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px auto; }
        .btn-main { padding: 15px 25px; cursor: pointer; background: var(--primary); color: white; border: none; border-radius: 12px; width: 100%; margin-top: 20px; font-size: 1.1rem; font-weight: bold; }
        #feedback { margin-top: 10px; font-weight: bold; min-height: 24px; font-size: 1.1rem; }
        .review-count { font-size: 0.7rem; display: block; color: #e67e22; }
    </style>
</head>
<body>

<div class="card" id="game-card">
    <div id="game-content">
        <div class="header-controls">
            <div class="top-row">
                <div class="mode-selector">
                    <div class="mode-option active" onclick="changeMode('choice')">4æŠ</div>
                    <div class="mode-option" onclick="changeMode('spell')">æ›¸ã</div>
                    <div class="mode-option" onclick="changeMode('listen')">èã</div>
                    <div class="mode-option review-mode" onclick="changeMode('review')">å¾©ç¿’ <span id="review-badge" class="review-count">(0)</span></div>
                    <div class="mode-option" id="time-tri-btn" onclick="toggleTimeTrial()">â±</div>
                </div>
                <div id="timer" class="timer-display">10:00</div>
            </div>
            <div class="highscore-display">æœ€é«˜è¨˜éŒ²: <span id="high-score">0</span></div>
        </div>
        <div class="score-board" style="color:#7f8c8d; margin-bottom:5px; font-size: 0.9rem; font-weight: bold;">
            ã‚¹ã‚³ã‚¢: <span id="score" style="color:var(--primary);">0</span>
        </div>
        <div class="word-display"><span id="target-display">Start!</span></div>
        
        <button id="speaker-icon" class="speaker-btn" onclick="retrySpeak()">ğŸ”Š</button>
        
        <div class="options-grid" id="options"></div>
        
        <div id="spell-input-area">
            <input type="text" id="spell-input" placeholder="ã‚¹ãƒšãƒ«ã‚’å…¥åŠ›..." autocomplete="off">
            <br>
            <button class="hint-btn" onclick="showHint()">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</button>
            <div id="hint-text" style="font-size: 0.8rem; color: #f39c12; letter-spacing: 2px; height: 20px;"></div>
        </div>
        
        <div id="feedback"></div>
    </div>
</div>

<script>
    const masterWordList = [
        { en: "Hello", ja: "ã“ã‚“ã«ã¡ã¯" },
        { en: "Thank you", ja: "ã‚ã‚ŠãŒã¨ã†" },
        { en: "Excuse me", ja: "ã™ã¿ã¾ã›ã‚“" },
        { en: "I'm sorry", ja: "ã”ã‚ã‚“ãªã•ã„" },
        { en: "Good morning", ja: "ãŠã¯ã‚ˆã†" },
        { en: "Good night", ja: "ãŠã‚„ã™ã¿ãªã•ã„" },
        { en: "Nice to meet you", ja: "ã¯ã˜ã‚ã¾ã—ã¦" },
        { en: "How are you?", ja: "ãŠå…ƒæ°—ã§ã™ã‹ï¼Ÿ" },
        { en: "Please", ja: "ãŠé¡˜ã„ã—ã¾ã™" },
        { en: "my", ja: "ç§ã®" },
        { en: "me", ja: "ç§ã‚’" },
        { en: "mine", ja: "ç§ã®ã‚‚ã®" },
        { en: "yours", ja: "ã‚ãªãŸã®ã‚‚ã®" },
        { en: "his", ja: "å½¼ã®" },
        { en: "she", ja: "å½¼å¥³" },
        { en: "her", ja: "å½¼å¥³ã®" },
        { en: "hers", ja: "å½¼å¥³ã®ã‚‚ã®" },
        { en: "it", ja: "ãã‚Œ" },
        { en: "its", ja: "ãã‚Œã®" },
        { en: "they", ja: "å½¼ã‚‰ã€ãã‚Œã‚‰" },
        { en: "their", ja: "å½¼ã‚‰ã®ã€ãã‚Œã‚‰ã®" },
        { en: "them", ja: "å½¼ã‚‰ã‚’ã€ãã‚Œã‚‰ã‚’" },
        { en: "theirs", ja: "å½¼ã‚‰ã®ã‚‚ã®ã€ãã‚Œã‚‰ã®ã‚‚ã®" },
        { en: "we", ja: "ç§ãŸã¡" },
        { en: "our", ja: "ç§ãŸã¡ã®" },
        { en: "us", ja: "ç§ãŸã¡ã‚’" },
        { en: "ours", ja: "ç§ãŸã¡ã®ã‚‚ã®" },
        { en: "what", ja: "ä½•" },
        { en: "what color", ja: "ä½•è‰²" },
        { en: "what sports", ja: "ä½•ã®ã‚¹ãƒãƒ¼ãƒ„" },
        { en: "what subject", ja: "ä½•ã®ç§‘ç›®" },
        { en: "where", ja: "ã©ã“" },
        { en: "when", ja: "ã„ã¤" },
        { en: "who", ja: "èª°" },
        { en: "whose", ja: "èª°ã®" },
        { en: "which", ja: "ã©ã¡ã‚‰ã®" },
        { en: "how", ja: "ã©ã†ã‚„ã£ã¦" },
        { en: "sunny", ja: "æ™´ã‚Œã¦ã„ã‚‹" }, 
        { en: "cloudy", ja: "æ›‡ã£ã¦ã„ã‚‹" }, 
        { en: "rainy", ja: "é›¨ãŒé™ã£ã¦ã„ã‚‹" }, 
        { en: "snowy", ja: "é›ªãŒé™ã£ã¦ã„ã‚‹" }, 
        { en: "Japan", ja: "æ—¥æœ¬" }, 
        { en: "America", ja: "ã‚¢ãƒ¡ãƒªã‚«" }, 
        { en: "friend", ja: "å‹ã ã¡" }, 
        { en: "apple", ja: "ã‚Šã‚“ã”" },
        { en: "book", ja: "æœ¬" },
        { en: "school", ja: "å­¦æ ¡" },
        { en: "student", ja: "ç”Ÿå¾’" },
        { en: "teacher", ja: "å…ˆç”Ÿ" },
        { en: "dog", ja: "çŠ¬" },
        { en: "cat", ja: "çŒ«" },
        { en: "bird", ja: "é³¥" },
        { en: "water", ja: "æ°´" },
        { en: "food", ja: "é£Ÿã¹ç‰©" },
        { en: "time", ja: "æ™‚é–“" },
        { en: "money", ja: "ãŠé‡‘" },
        { en: "happy", ja: "å¹¸ã›ãª" },
        { en: "sad", ja: "æ‚²ã—ã„" },
        { en: "big", ja: "å¤§ãã„" },
        { en: "small", ja: "å°ã•ã„" }
    ];

    let currentActiveList = [], currentIndex = 0, score = 0, isChecking = false;
    let currentMode = 'choice', isTimeTrial = false, timerInterval = null, timeLeft = 600;
    
    // é–“é•ãˆãŸå˜èªã‚’ä¿å­˜ã™ã‚‹ãƒªã‚¹ãƒˆï¼ˆlocalStorageåŒæœŸï¼‰
    let reviewList = JSON.parse(localStorage.getItem('review_words') || '[]');

    function shuffle(array) {
        let arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    function updateReviewBadge() {
        document.getElementById('review-badge').textContent = `(${reviewList.length})`;
    }

    function changeMode(mode) {
        if (mode === 'review' && reviewList.length === 0) {
            alert("å¾©ç¿’ãŒå¿…è¦ãªå˜èªã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼");
            return;
        }
        currentMode = mode;
        const opts = document.querySelectorAll('.mode-option');
        opts[0].classList.toggle('active', mode === 'choice');
        opts[1].classList.toggle('active', mode === 'spell');
        opts[2].classList.toggle('active', mode === 'listen');
        opts[3].classList.toggle('active', mode === 'review');
        updateHighScoreDisplay();
        resetProgress();
    }

    function toggleTimeTrial() {
        isTimeTrial = !isTimeTrial;
        document.getElementById('timer').style.visibility = isTimeTrial ? 'visible' : 'hidden';
        document.getElementById('time-tri-btn').classList.toggle('active');
        if(isTimeTrial) startTimer(); else stopTimer();
        resetProgress();
    }

    function startTimer() { stopTimer(); timeLeft = 600; updateTimerText(); timerInterval = setInterval(() => { timeLeft--; updateTimerText(); if(timeLeft <= 0) { stopTimer(); finish("ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼"); } }, 1000); }
    function stopTimer() { clearInterval(timerInterval); }
    function updateTimerText() { const m = Math.floor(timeLeft / 60); const s = timeLeft % 60; document.getElementById('timer').textContent = `${m}:${s.toString().padStart(2, '0')}`; }
    function updateHighScoreDisplay() { document.getElementById('high-score').textContent = localStorage.getItem(`hs_${currentMode}_${isTimeTrial}`) || 0; }

    function resetProgress() {
        if (currentMode === 'review') {
            currentActiveList = shuffle(reviewList);
        } else {
            currentActiveList = shuffle(masterWordList);
        }
        currentIndex = 0; score = 0;
        document.getElementById('score').textContent = "0";
        showQuestion();
    }

    function showQuestion() {
        if (currentActiveList.length === 0) {
            finish("å˜èªãƒªã‚¹ãƒˆãŒç©ºã§ã™ï¼");
            return;
        }
        if (currentIndex >= currentActiveList.length) {
            if(isTimeTrial) { currentActiveList = shuffle(currentMode === 'review' ? reviewList : masterWordList); currentIndex = 0; }
            else { finish("å…¨å•çµ‚äº†ï¼"); return; }
        }
        isChecking = false;
        const q = currentActiveList[currentIndex];
        document.getElementById('feedback').textContent = "";
        document.getElementById('hint-text').textContent = "";
        const display = document.getElementById('target-display');
        const inputArea = document.getElementById('spell-input-area');
        const optionsArea = document.getElementById('options');
        const speaker = document.getElementById('speaker-icon');

        // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ã‚¹ãƒšãƒ«å…¥åŠ›å›ºå®šã«ã™ã‚‹ã‹ã€ã¾ãŸã¯ç¾åœ¨ã®ã‚µãƒ–ãƒ¢ãƒ¼ãƒ‰è¨­å®šã‚’ç¶­æŒ
        // ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œå¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ï¼4æŠã€ã§å®Ÿè£…ï¼ˆãŠå¥½ã¿ã§å¤‰æ›´å¯èƒ½ï¼‰
        if (currentMode === 'spell') {
            display.textContent = q.ja; speaker.style.display = 'none'; inputArea.style.display = 'block'; optionsArea.style.display = 'none';
            const input = document.getElementById('spell-input'); input.value = ""; input.disabled = false; input.focus();
        } else if (currentMode === 'listen') {
            display.textContent = "???"; speaker.style.display = 'flex'; inputArea.style.display = 'none'; optionsArea.style.display = 'grid';
            speak(q.en); setupOptions(q);
        } else {
            // 4æŠã¾ãŸã¯å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰
            display.textContent = q.en; speaker.style.display = 'flex'; inputArea.style.display = 'none'; optionsArea.style.display = 'grid';
            speak(q.en); setupOptions(q);
        }
    }

    function setupOptions(q) {
        // èª¤ç­”ã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
        const others = masterWordList.filter(w => w.ja !== q.ja);
        const opts = shuffle([q.ja, ...shuffle(others).slice(0, 3).map(w => w.ja)]);
        const container = document.getElementById('options');
        container.innerHTML = '';
        opts.forEach(o => {
            const btn = document.createElement('button');
            btn.className = 'option-btn'; btn.textContent = o;
            btn.onclick = () => check(o === q.ja, btn);
            container.appendChild(btn);
        });
    }

    function check(isCorrect, targetElement = null) {
        if(isChecking) return;
        isChecking = true;
        const q = currentActiveList[currentIndex];
        
        if (currentMode === 'listen') document.getElementById('target-display').textContent = q.en;

        const feedback = document.getElementById('feedback');
        if(isCorrect) {
            if(targetElement) targetElement.classList.add('correct');
            score++; document.getElementById('score').textContent = score;
            feedback.innerHTML = `<span style="color:var(--primary)">âœ¨æ­£è§£: ${q.en}</span>`;
            
            // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ä¸­ã«æ­£è§£ã—ãŸã‚‰ãƒªã‚¹ãƒˆã‹ã‚‰æ¶ˆã™
            if (currentMode === 'review') {
                reviewList = reviewList.filter(item => item.en !== q.en);
                localStorage.setItem('review_words', JSON.stringify(reviewList));
                updateReviewBadge();
            }
        } else {
            if(targetElement) targetElement.classList.add('wrong');
            feedback.innerHTML = `<span style="color:var(--time)">âŒä¸æ­£è§£: ${q.en}</span>`;
            
            // é–“é•ãˆãŸã‚‰å¾©ç¿’ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆé‡è¤‡ãªã—ï¼‰
            if (!reviewList.some(item => item.en === q.en)) {
                reviewList.push(q);
                localStorage.setItem('review_words', JSON.stringify(reviewList));
                updateReviewBadge();
            }
        }
        
        speak(q.en);
        setTimeout(() => { currentIndex++; showQuestion(); }, isCorrect ? 1000 : 2500);
    }

    function showHint() {
        const q = currentActiveList[currentIndex];
        if(!q) return;
        const hint = q.en[0] + "_".repeat(q.en.length - 2) + q.en.slice(-1);
        document.getElementById('hint-text').textContent = hint;
    }

    function speak(text) {
        if (!('speechSynthesis' in window)) return;
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        const voices = speechSynthesis.getVoices();
        const nativeVoice = voices.find(v => 
            v.lang === 'en-US' && (v.name.includes('Google') || v.name.includes('Samantha') || v.name.includes('Premium'))
        ) || voices.find(v => v.lang.startsWith('en'));
        if (nativeVoice) u.voice = nativeVoice;
        u.lang = 'en-US';
        u.rate = 0.85; 
        speechSynthesis.speak(u);
    }

    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
    }

    function retrySpeak() { if (currentActiveList[currentIndex]) speak(currentActiveList[currentIndex].en); }

    document.getElementById('spell-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const val = document.getElementById('spell-input').value.trim().toLowerCase();
            check(val === currentActiveList[currentIndex].en.toLowerCase());
        }
    });

    function finish(msg) {
        stopTimer();
        const key = `hs_${currentMode}_${isTimeTrial}`;
        const oldHS = parseInt(localStorage.getItem(key) || 0);
        if(score > oldHS) localStorage.setItem(key, score);
        document.getElementById('game-card').innerHTML = `
            <h2>${msg}</h2>
            <p style="font-size:1.8rem; color:var(--primary); font-weight:bold;">ã‚¹ã‚³ã‚¢: ${score}</p>
            <p>æœ€é«˜è¨˜éŒ²: ${Math.max(score, oldHS)}</p>
            <p style="color:#e67e22;">å¾©ç¿’ãŒå¿…è¦ãªå˜èª: ${reviewList.length} ä»¶</p>
            <button onclick="location.reload()" class="btn-main">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
        `;
    }

    (function init() {
        updateReviewBadge();
        updateHighScoreDisplay();
        resetProgress();
    })();

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
        .then(() => console.log("Service Worker Registered"))
        .catch(err => console.log("Service Worker Failed", err));
    }
</script>
</body>
</html>