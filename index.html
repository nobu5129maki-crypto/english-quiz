<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±å˜èªãƒã‚¹ã‚¿ãƒ¼ Pro (GitHubåæ˜ ç‰ˆ)</title>
    <style>
        :root { --primary: #4CAF50; --bg: #eef2f3; --review: #f39c12; --listen: #9b59b6; --time: #e74c3c; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .card { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; position: relative; }
        .header-controls { display: flex; flex-direction: column; gap: 10px; margin-bottom: 1rem; }
        .top-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .mode-selector { display: flex; background: #ddd; border-radius: 12px; padding: 4px; gap: 4px; flex-grow: 1; flex-wrap: wrap; }
        .mode-option { flex: 1; min-width: 45px; padding: 8px 5px; font-size: 0.75rem; border-radius: 8px; cursor: pointer; font-weight: bold; color: #666; transition: 0.3s; text-align: center; border: none; background: transparent; }
        .mode-option.active { background: white !important; color: var(--primary) !important; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .mode-option.review-mode.active { color: var(--review) !important; }
        .review-count-badge { background: var(--review); color: white; border-radius: 10px; padding: 1px 6px; font-size: 0.65rem; margin-left: 2px; display: none; }
        #time-tri-btn { font-size: 1.2rem; cursor: pointer; border-radius: 8px; }
        #time-tri-btn.active { color: var(--time); background: #ffdada; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .timer-display { font-size: 1.2rem; font-weight: bold; color: var(--time); visibility: hidden; min-width: 60px; }
        .highscore-display { font-size: 0.8rem; color: #7f8c8d; margin-top: 5px; background: #f9f9f9; padding: 4px; border-radius: 8px; }
        .word-display { font-size: 2.2rem; font-weight: bold; margin-bottom: 1rem; color: #2c3e50; min-height: 3.5rem; display: flex; justify-content: center; align-items: center; }
        .options-grid { display: grid; gap: 10px; }
        .option-btn { padding: 14px; border: 2px solid #ddd; border-radius: 12px; background: white; cursor: pointer; font-size: 1rem; font-weight: bold; transition: 0.2s; }
        .option-btn.correct { background: #d4edda !important; border-color: #28a745 !important; color: #155724 !important; animation: correctPulse 0.5s ease; }
        .option-btn.wrong { background: #f8d7da !important; border-color: #dc3545 !important; color: #721c24 !important; }
        @keyframes correctPulse { 0% { transform: scale(1); } 50% { transform: scale(1.08); box-shadow: 0 0 20px rgba(40,167,69,0.6); } 100% { transform: scale(1); } }
        #spell-input-area { display: none; }
        #spell-input { width: 100%; padding: 14px; font-size: 1.4rem; border: 2px solid #ddd; border-radius: 12px; text-align: center; margin-bottom: 10px; box-sizing: border-box; }
        .hint-btn { background: none; border: 1px solid #aaa; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; color: #666; margin-bottom: 10px; }
        .speaker-btn { background: #f0f0f0; border-radius: 50%; width: 55px; height: 55px; cursor: pointer; font-size: 1.6rem; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px auto; border: none; }
        .btn-main { padding: 15px 25px; cursor: pointer; background: var(--primary); color: white; border: none; border-radius: 12px; width: 100%; margin-top: 20px; font-size: 1.1rem; font-weight: bold; }
        #feedback { margin-top: 10px; font-weight: bold; min-height: 24px; font-size: 1.1rem; }
        .success-overlay { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(76,175,80,0.15); z-index: 100; animation: successFade 0.4s ease; pointer-events: none; }
        @keyframes successFade { 0% { opacity: 0; } 100% { opacity: 1; } }
        .success-message { font-size: 2rem; font-weight: bold; color: #2e7d32; text-shadow: 0 0 20px rgba(255,255,255,0.8); animation: successBounce 0.6s ease; }
        @keyframes successBounce { 0% { transform: scale(0.5); opacity: 0; } 60% { transform: scale(1.15); opacity: 1; } 80% { transform: scale(0.95); } 100% { transform: scale(1); } }
        .success-emoji { font-size: 4rem; line-height: 1; margin-bottom: 8px; animation: emojiPop 0.5s ease 0.1s both; }
        @keyframes emojiPop { 0% { transform: scale(0); rotate: -20deg; } 70% { transform: scale(1.3); rotate: 10deg; } 100% { transform: scale(1); rotate: 0deg; } }
        .success-word { font-size: 1.3rem; color: #1b5e20; margin-top: 5px; font-weight: 600; }
        .confetti { position: fixed; top: 0; width: 10px; height: 10px; pointer-events: none; z-index: 99; }
        .confetti span { display: block; width: 100%; height: 100%; border-radius: 2px; animation: confettiFall 1.2s ease-out forwards; }
        @keyframes confettiFall { 0% { transform: translateY(-20px) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
    </style>
</head>
<body>

<div class="card" id="game-card">
    <div id="game-content">
        <div class="header-controls">
            <div class="top-row">
                <div class="mode-selector">
                    <button class="mode-option active" id="btn-choice" onclick="changeMode('choice')">4æŠ</button>
                    <button class="mode-option" id="btn-spell" onclick="changeMode('spell')">æ›¸ã</button>
                    <button class="mode-option" id="btn-listen" onclick="changeMode('listen')">èã</button>
                    <button class="mode-option" id="btn-review" onclick="changeMode('review')">
                        å¾©ç¿’<span id="review-badge" class="review-count-badge">0</span>
                    </button>
                    <button class="mode-option" id="time-tri-btn" onclick="toggleTimeTrial()">â±</button>
                </div>
                <div id="timer" class="timer-display">10:00</div>
            </div>
            <div class="highscore-display">æœ€é«˜è¨˜éŒ²: <span id="high-score">0</span></div>
        </div>
        <div class="score-board" style="color:#7f8c8d; margin-bottom:5px; font-size: 0.9rem; font-weight: bold;">
            ã‚¹ã‚³ã‚¢: <span id="score" style="color:var(--primary);">0</span>
        </div>
        <div class="word-display"><span id="target-display">æº–å‚™ä¸­...</span></div>
        
        <button id="speaker-icon" class="speaker-btn" onclick="retrySpeak()">ğŸ”Š</button>
        
        <div class="options-grid" id="options"></div>
        
        <div id="spell-input-area">
            <input type="text" id="spell-input" placeholder="ã‚¹ãƒšãƒ«ã‚’å…¥åŠ›..." autocomplete="off">
            <br>
            <button class="hint-btn" onclick="showHint()">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</button>
            <div id="hint-text" style="font-size: 0.8rem; color: #f39c12; letter-spacing: 2px; height: 20px;"></div>
        </div>
        
        <div id="feedback"></div>
    </div>
</div>

<script>
    // å˜èªãƒªã‚¹ãƒˆ
    const masterWordList = [
        { en: "Hello", ja: "ã“ã‚“ã«ã¡ã¯" }, { en: "Thank you", ja: "ã‚ã‚ŠãŒã¨ã†" },
        { en: "Excuse me", ja: "ã™ã¿ã¾ã›ã‚“" }, { en: "I'm sorry", ja: "ã”ã‚ã‚“ãªã•ã„" },
        { en: "Good morning", ja: "ãŠã¯ã‚ˆã†" }, { en: "Good night", ja: "ãŠã‚„ã™ã¿ãªã•ã„" },
        { en: "Nice to meet you", ja: "ã¯ã˜ã‚ã¾ã—ã¦" }, { en: "How are you?", ja: "ãŠå…ƒæ°—ã§ã™ã‹ï¼Ÿ" },
        { en: "Please", ja: "ãŠé¡˜ã„ã—ã¾ã™" }, { en: "my", ja: "ç§ã®" },
        { en: "me", ja: "ç§ã‚’" }, { en: "mine", ja: "ç§ã®ã‚‚ã®" },
        { en: "yours", ja: "ã‚ãªãŸã®ã‚‚ã®" }, { en: "his", ja: "å½¼ã®" },
        { en: "she", ja: "å½¼å¥³" }, { en: "her", ja: "å½¼å¥³ã®" },
        { en: "hers", ja: "å½¼å¥³ã®ã‚‚ã®" }, { en: "it", ja: "ãã‚Œ" },
        { en: "its", ja: "ãã‚Œã®" }, { en: "they", ja: "å½¼ã‚‰ã€ãã‚Œã‚‰" },
        { en: "their", ja: "å½¼ã‚‰ã®ã€ãã‚Œã‚‰ã®" }, { en: "them", ja: "å½¼ã‚‰ã‚’ã€ãã‚Œã‚‰ã‚’" },
        { en: "theirs", ja: "å½¼ã‚‰ã®ã‚‚ã®ã€ãã‚Œã‚‰ã®ã‚‚ã®" }, { en: "we", ja: "ç§ãŸã¡" },
        { en: "our", ja: "ç§ãŸã¡ã®" }, { en: "us", ja: "ç§ãŸã¡ã‚’" },
        { en: "ours", ja: "ç§ãŸã¡ã®ã‚‚ã®" }, { en: "what", ja: "ä½•" },
        { en: "where", ja: "ã©ã“" }, { en: "when", ja: "ã„ã¤" },
        { en: "who", ja: "èª°" }, { en: "whose", ja: "èª°ã®" },
        { en: "which", ja: "ã©ã¡ã‚‰ã®" }, { en: "how", ja: "ã©ã†ã‚„ã£ã¦" },
        { en: "sunny", ja: "æ™´ã‚Œã¦ã„ã‚‹" }, { en: "cloudy", ja: "æ›‡ã£ã¦ã„ã‚‹" }, 
        { en: "rainy", ja: "é›¨ãŒé™ã£ã¦ã„ã‚‹" }, { en: "snowy", ja: "é›ªãŒé™ã£ã¦ã„ã‚‹" }, 
        { en: "friend", ja: "å‹ã ã¡" }, { en: "apple", ja: "ã‚Šã‚“ã”" },
        { en: "book", ja: "æœ¬" }, { en: "school", ja: "å­¦æ ¡" },
        { en: "student", ja: "ç”Ÿå¾’" }, { en: "teacher", ja: "å…ˆç”Ÿ" },
        { en: "dog", ja: "çŠ¬" }, { en: "cat", ja: "çŒ«" },
        { en: "water", ja: "æ°´" }, { en: "food", ja: "é£Ÿã¹ç‰©" },
        { en: "happy", ja: "å¹¸ã›ãª" }, { en: "sad", ja: "æ‚²ã—ã„" },
        { en: "big", ja: "å¤§ãã„" }, { en: "small", ja: "å°ã•ã„" }
    ];

    let currentActiveList = [], currentIndex = 0, score = 0, isChecking = false;
    let currentMode = 'choice', isTimeTrial = false, timerInterval = null, timeLeft = 600;
    let reviewList = [];
    let selectedVoice = null; // ãƒã‚¤ãƒ†ã‚£ãƒ–ç™ºéŸ³ç”¨ã®æœ€é©ãªéŸ³å£°

    // localStorageåˆæœŸåŒ–
    function loadData() {
        try {
            const saved = localStorage.getItem('review_words');
            reviewList = saved ? JSON.parse(saved) : [];
        } catch(e) {
            reviewList = [];
        }
        updateReviewBadge();
        updateHighScoreDisplay();
    }

    function saveData() {
        localStorage.setItem('review_words', JSON.stringify(reviewList));
    }

    function updateReviewBadge() {
        const badge = document.getElementById('review-badge');
        if(!badge) return;
        badge.textContent = reviewList.length;
        badge.style.display = reviewList.length > 0 ? "inline" : "none";
    }

    function shuffle(array) {
        return array.map(a => ({ sort: Math.random(), value: a }))
                    .sort((a, b) => a.sort - b.sort)
                    .map(a => a.value);
    }

    function changeMode(mode) {
        if (mode === 'review' && reviewList.length === 0) {
            alert("å¾©ç¿’ãƒªã‚¹ãƒˆã¯ç¾åœ¨ç©ºã§ã™ã€‚å•é¡Œã‚’é–“é•ãˆã‚‹ã¨è‡ªå‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ï¼");
            return;
        }
        currentMode = mode;
        
        // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’æ›´æ–°
        document.querySelectorAll('.mode-option').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.getElementById(`btn-${mode}`);
        if(activeBtn) activeBtn.classList.add('active');
        
        updateHighScoreDisplay();
        resetProgress();
    }

    function toggleTimeTrial() {
        isTimeTrial = !isTimeTrial;
        document.getElementById('timer').style.visibility = isTimeTrial ? 'visible' : 'hidden';
        document.getElementById('time-tri-btn').classList.toggle('active');
        if(isTimeTrial) startTimer(); else stopTimer();
        resetProgress();
    }

    function startTimer() { 
        stopTimer(); 
        timeLeft = 600; 
        updateTimerText(); 
        timerInterval = setInterval(() => { 
            timeLeft--; 
            updateTimerText(); 
            if(timeLeft <= 0) { stopTimer(); finish("ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼"); } 
        }, 1000); 
    }
    
    function stopTimer() { clearInterval(timerInterval); }
    function updateTimerText() { 
        const m = Math.floor(timeLeft / 60); 
        const s = timeLeft % 60; 
        document.getElementById('timer').textContent = `${m}:${s.toString().padStart(2, '0')}`; 
    }
    
    function updateHighScoreDisplay() { 
        const key = `hs_${currentMode}_${isTimeTrial}`;
        document.getElementById('high-score').textContent = localStorage.getItem(key) || 0; 
    }

    function resetProgress() {
        if (currentMode === 'review') {
            if (reviewList.length === 0) {
                currentMode = 'choice';
                document.getElementById('btn-choice').classList.add('active');
                document.getElementById('btn-review').classList.remove('active');
                currentActiveList = shuffle(masterWordList);
            } else {
                currentActiveList = shuffle(reviewList);
            }
        } else {
            currentActiveList = shuffle(masterWordList);
        }
        currentIndex = 0; score = 0;
        document.getElementById('score').textContent = "0";
        showQuestion();
    }

    function showQuestion() {
        if (currentActiveList.length === 0) {
            finish("ãƒªã‚¹ãƒˆãŒç©ºã§ã™ï¼");
            return;
        }
        if (currentIndex >= currentActiveList.length) {
            if(isTimeTrial) { 
                currentActiveList = shuffle(currentMode === 'review' ? reviewList : masterWordList); 
                currentIndex = 0; 
            } else { 
                finish("å…¨å•çµ‚äº†ï¼"); return; 
            }
        }
        
        isChecking = false;
        const q = currentActiveList[currentIndex];
        document.getElementById('feedback').textContent = "";
        document.getElementById('hint-text').textContent = "";
        
        const display = document.getElementById('target-display');
        const inputArea = document.getElementById('spell-input-area');
        const optionsArea = document.getElementById('options');
        const speaker = document.getElementById('speaker-icon');

        if (currentMode === 'spell') {
            display.textContent = q.ja; 
            speaker.style.display = 'none'; 
            inputArea.style.display = 'block'; 
            optionsArea.style.display = 'none';
            const input = document.getElementById('spell-input'); 
            input.value = ""; 
            input.disabled = false; 
            setTimeout(() => input.focus(), 100);
        } else if (currentMode === 'listen') {
            display.textContent = "???"; 
            speaker.style.display = 'flex'; 
            inputArea.style.display = 'none'; 
            optionsArea.style.display = 'grid';
            speak(q.en); setupOptions(q);
        } else {
            display.textContent = q.en; 
            speaker.style.display = 'flex'; 
            inputArea.style.display = 'none'; 
            optionsArea.style.display = 'grid';
            speak(q.en); setupOptions(q);
        }
    }

    function setupOptions(q) {
        const others = masterWordList.filter(w => w.ja !== q.ja);
        const opts = shuffle([q.ja, ...shuffle(others).slice(0, 3).map(w => w.ja)]);
        const container = document.getElementById('options');
        container.innerHTML = '';
        opts.forEach(o => {
            const btn = document.createElement('button');
            btn.className = 'option-btn'; btn.textContent = o;
            btn.onclick = () => check(o === q.ja, btn);
            container.appendChild(btn);
        });
    }

    function showSuccessOverlay(praise, word) {
        const colors = ['#4CAF50', '#8BC34A', '#FFEB3B', '#FF9800', '#E91E63'];
        for (let i = 0; i < 15; i++) {
            const c = document.createElement('div');
            c.className = 'confetti';
            c.style.left = Math.random() * 100 + 'vw';
            const span = document.createElement('span');
            span.style.background = colors[Math.floor(Math.random() * colors.length)];
            span.style.animationDelay = (Math.random() * 0.3) + 's';
            c.appendChild(span);
            document.body.appendChild(c);
            setTimeout(() => c.remove(), 1300);
        }
        const overlay = document.createElement('div');
        overlay.className = 'success-overlay';
        overlay.innerHTML = `
            <div class="success-emoji">ğŸ‰</div>
            <div class="success-message">${praise}</div>
            <div class="success-word">${word}</div>
        `;
        document.body.appendChild(overlay);
        setTimeout(() => overlay.remove(), 700);
    }

    function check(isCorrect, targetElement = null) {
        if(isChecking) return;
        isChecking = true;
        const q = currentActiveList[currentIndex];
        
        if (currentMode === 'listen') document.getElementById('target-display').textContent = q.en;

        const feedback = document.getElementById('feedback');
        if(isCorrect) {
            if(targetElement) targetElement.classList.add('correct');
            score++; 
            document.getElementById('score').textContent = score;
            
            // æ­£è§£æ™‚ã®ç››å¤§ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            const praises = ['ã‚„ã£ãŸã­ï¼', 'ã™ã”ã„ï¼', 'å®Œç’§ï¼', 'ãƒŠã‚¤ã‚¹ï¼', 'ãã®èª¿å­ï¼', 'ã•ã™ãŒï¼'];
            const praise = praises[Math.floor(Math.random() * praises.length)];
            showSuccessOverlay(praise, q.en);
            feedback.innerHTML = `<span style="color:var(--primary); font-size:1.2rem;">âœ¨ æ­£è§£: ${q.en}</span>`;
            
            if (currentMode === 'review') {
                reviewList = reviewList.filter(item => item.en !== q.en);
                saveData();
                updateReviewBadge();
            }
        } else {
            if(targetElement) targetElement.classList.add('wrong');
            feedback.innerHTML = `<span style="color:var(--time)">âŒ ä¸æ­£è§£: ${q.en}</span>`;
            
            if (!reviewList.find(item => item.en === q.en)) {
                reviewList.push(q);
                saveData();
                updateReviewBadge();
            }
        }
        
        speak(q.en);
        setTimeout(() => { currentIndex++; showQuestion(); }, isCorrect ? 1100 : 2000);
    }

    function showHint() {
        const q = currentActiveList[currentIndex];
        if(!q) return;
        const hint = q.en[0] + "_".repeat(q.en.length - 2) + q.en.slice(-1);
        document.getElementById('hint-text').textContent = hint;
    }

    // ãƒã‚¤ãƒ†ã‚£ãƒ–ã«è¿‘ã„è‹±èªéŸ³å£°ã‚’é¸æŠï¼ˆen-USå„ªå…ˆã€é«˜å“è³ªéŸ³å£°ã‚’å„ªå…ˆï¼‰
    function selectBestEnglishVoice() {
        const voices = speechSynthesis.getVoices();
        const enVoices = voices.filter(v => v.lang.startsWith('en'));
        if (enVoices.length === 0) return null;
        // é«˜å“è³ªãƒã‚¤ãƒ†ã‚£ãƒ–éŸ³å£°ã®å„ªå…ˆãƒªã‚¹ãƒˆï¼ˆChrome/Edge/Safariå¯¾å¿œï¼‰
        const preferredNames = ['Google US English', 'Microsoft Zira', 'Microsoft David', 'Samantha', 'Alex', 'Karen', 'Daniel', 'Mark'];
        for (const name of preferredNames) {
            const v = enVoices.find(x => x.name.includes(name));
            if (v) return v;
        }
        // en-US ã‚’å„ªå…ˆã€æ¬¡ã« en-GB
        const us = enVoices.find(v => v.lang === 'en-US');
        if (us) return us;
        const gb = enVoices.find(v => v.lang === 'en-GB');
        if (gb) return gb;
        return enVoices[0];
    }

    function initVoices() {
        const voices = speechSynthesis.getVoices();
        if (voices.length > 0 && !selectedVoice) {
            selectedVoice = selectBestEnglishVoice();
        }
    }

    function speak(text) {
        if (!('speechSynthesis' in window)) return;
        speechSynthesis.cancel();
        initVoices(); // éŸ³å£°ãŒæœªèª­ã¿è¾¼ã¿ã®å ´åˆã«å‚™ãˆã‚‹
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        u.rate = 0.95;  // ã‚„ã‚„ã‚†ã£ãã‚Šã§èãå–ã‚Šã‚„ã™ãã€è‡ªç„¶ãªé€Ÿåº¦
        u.pitch = 1.0;  // è‡ªç„¶ãªãƒ”ãƒƒãƒ
        u.volume = 1.0;
        if (selectedVoice) u.voice = selectedVoice;
        speechSynthesis.speak(u);
    }

    function retrySpeak() { if (currentActiveList[currentIndex]) speak(currentActiveList[currentIndex].en); }

    document.getElementById('spell-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const val = document.getElementById('spell-input').value.trim().toLowerCase();
            if(val === "") return;
            check(val === currentActiveList[currentIndex].en.toLowerCase());
        }
    });

    function finish(msg) {
        stopTimer();
        const key = `hs_${currentMode}_${isTimeTrial}`;
        const oldHS = parseInt(localStorage.getItem(key) || 0);
        if(score > oldHS) localStorage.setItem(key, score);
        
        document.getElementById('game-card').innerHTML = `
            <h2>${msg}</h2>
            <div style="font-size:2.5rem; color:var(--primary); font-weight:bold; margin: 20px 0;">${score}ç‚¹</div>
            <p>ä»Šå›ã®æœ€é«˜è¨˜éŒ²: ${Math.max(score, oldHS)}</p>
            <div style="background:#fff3e0; padding:15px; border-radius:10px; margin-top:20px;">
                <p style="color:#e67e22; margin:0; font-weight:bold;">å¾©ç¿’ãŒå¿…è¦ãªå˜èª: ${reviewList.length} ä»¶</p>
            </div>
            <button onclick="location.reload()" class="btn-main">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
        `;
    }

    // éŸ³å£°ãƒªã‚¹ãƒˆã®éåŒæœŸèª­ã¿è¾¼ã¿ã«å¯¾å¿œ
    if ('speechSynthesis' in window) {
        speechSynthesis.onvoiceschanged = initVoices;
        initVoices(); // æ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿ã®å ´åˆ
    }

    // å³æ™‚å®Ÿè¡Œ
    loadData();
    resetProgress();

</script>
</body>
</html>